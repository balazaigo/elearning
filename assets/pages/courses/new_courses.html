<style type="text/css">
.custom-file {
  width: 100%;
  height: 60px;
  line-height: 60px;
  background-color: #e9e8ed;
  border-radius: 5px;
  text-align: center;
  font-size: 17px;
  color: #9e9e9e;
}
.custom-file span {
  cursor:pointer;
  border: 1px solid #ccc;
  padding: 8px;
  border-radius: 8px;
}
input[type="file"] {
  display: none;
}
.has-error input,
.has-error input.form-control:focus {
  border-color:red;
  box-shadow:0 0 0 0.15rem rgb(253 13 13 / 25%);
}
em.error.help-block {
  color: red;
  font-size: 12px;
}
</style>
<div class="modal-header">
  <h5 class="modal-title">Add a new course</h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">    

  <form method="post" class="pop-form" id="frmNewCourses" name="frmNewCourses" enctype="multipart/form-data">
    <input type="hidden" name="platform_id" id="platform_id" value="1e4758ac-8077-42e6-b9d9-11b0de0df37d" >
    <div class="row">
      <div class="col-md-12 mb-3">
        <input type="text" id="coursesName" name="coursesName" class="form-control cm-capitalize" placeholder="Name of the Course">
      </div>
      <div class="col-md-12 mb-3">
        <input type="text" id="coursesID" name="coursesID" class="form-control" placeholder="Course ID Prefix">
      </div>
      <div class="col-md-12 mb-3 selectParent">
        <div class="dropdown-select">
          <select class="sort-select" id="category" name="category">
            <option value="">Select Category</option>
          </select>
        </div>
      </div>
      <div class="col-md-12 mb-3 selectParent">
       <div class="dropdown-select">
          <select class="sort-select" id="subCategory" name="subCategory">
            <option value="">Select Sub Category</option>
          </select>
        </div>
      </div>
      <div class="col-md-12 mb-3">
        <label class="custom-file">
          <input type="file" id="courseFile" name="courseFile[]" multiple class="form-control" placeholder="import a file">
          <span class="filename">Import a file</span>
        </label>
      </div>
    </div>
    <div class="row">
      <div class="col-md-6 mb-3">
        <input type="date" id="start_date" name="start_date" class="form-control" placeholder="Start Date">
      </div>
      <div class="col-md-6 mb-3">
        <input type="date" id="end_date" name="end_date" class="form-control" placeholder="End Date">
      </div>
    </div>
    <div class="row">
      <div class="col-md-12 mb-3 selectParent">
       <div class="dropdown-select">
          <select class="sort-select" id="member" name="member">
            <option value="">Assign to</option>
          </select>
        </div>
      </div>
      <div class="col-md-12 mb-3">
        <select class="form-control tags" id="tags" name="tags[]" required multiple="multiple" style="width:100%">
        </select>      
      </div>
      <div class="col-md-12 mb-3">
        <input type="text" id="description" name="description" class="form-control" placeholder="One line description">
      </div>
    </div>
  </form>

</div>
<div class="modal-footer">
  <span class="orange-btn nbtn">
    <button type="button" class="btn btn-primary" id="saveCourses">Save</button>
  </span>
</div>
<script type="text/javascript">
var subCategory = {};
var frmvalidatorfrm;

$.fn.extend({
	caps: function(str){
		"use strict";
		return str.charAt(0).toUpperCase() + str.slice(1);
	},
  capitalize: function(){
		"use strict";
		return this.each(function() {
			var $field = $(this);
			$field.on('keyup change', function() {
				$field.val(function(i, old) {
					if (old.indexOf(' ') > -1) {
						var words = old.split(' ');
						for (i = 0; i < words.length; i++) {
							words[i] = $.fn.caps(words[i]);
						}
						return words.join(' ');
					} else {
						return $.fn.caps(old);
					}
				});
			});
		});
	},
  upperCase: function() {
    "use strict";
    $(this).css('text-transform', 'uppercase').bind('blur change', function(){
      this.value = this.value.toUpperCase();
    });
  },
});

$( document ).ready(function() {
  
  $('.tags').select2({
    dropdownParent: $('#addCourses'),
    placeholder: "Add a tag",
    tags: true,
    maximumSelectionLength: 64,
    formatSelectionTooBig: function (limit) {
      return "Too many selected items, Only 64 tags allowed."
    },
    formatNoMatches: "add new tag and hit ENTER-KEY",
    escapeMarkup: function (markup) {
      return markup;
    }    
  });

  $('.cm-capitalize').each(function() { $(this).capitalize(); });
  $('.cm-uppercase').each(function() { $(this).upperCase(); });  

  $("#coursesName").on("blur", function(){
    var str = $(this).val();
    var acpref = str.substring(0, 4);
    $("#coursesID").val(acpref.toUpperCase());
  });
  
  $("input:file").change(function (){
    var fileName = $(this).val();
    console.log(fileName);
    $(".filename").html(fileName.replace("C:\\fakepath\\", ''));
  });

  $.validator.addMethod("pattern", function( value, element, param ) {
    if ( this.optional( element ) ) { return true; }
    if ( typeof param === "string" ) {
      param = new RegExp( "^(?:" + param + ")$" );
    }
    return param.test( value );
  }, "Check your inputs" );

  var frmvalidatorfrm = $("#frmNewCourses").validate({
    rules: {
      coursesName: {required: true, minlength: 1, maxlength: 256},
      coursesID: {required: true, minlength: 1, maxlength: 20},
      category: {required: true },
      subCategory: {required: true },
      courseFile: {required: true },
      start_date: {required: true },
      end_date: {required: true },
      member: {required: true },
    },
    messages: {
      coursesName: {
        required: "Please enter a Course Name",
        minlength: "Your course name must consist of at least 1 characters",
        maxlength: "Your course name must consist of max of 256 characters",
      },      
      coursesID: { required: "Please enter a Course ID Prefix",
        minlength: "Course ID Prefix must consist of at least 1 characters",
        maxlength: "Course ID Prefix must consist of max of 20 characters",
      },      
      category: {required: "Please select the category" },      
      subCategory: {required: "Please select the subcategory" },      
      courseFile: {required: "Please upload attachment" },      
      start_date: {required: "Please select starting date" },      
      end_date: {required: "Please select ending date" },      
      member: {required: "Please selct a member" },      
    },
    errorElement: "em",
    errorPlacement: function ( error, element ) {
      error.addClass( "help-block" );
      if ( element.prop( "type" ) === "checkbox" ) {
        error.insertAfter( element.parent( "label" ) );
      } else {
        error.insertAfter( element );
      }
    },
    highlight: function ( element, errorClass, validClass ) {
      $( element ).parents( ".col-md-12" ).addClass( "has-error" ).removeClass( "has-success" );
    },
    unhighlight: function (element, errorClass, validClass) {
      $( element ).parents( ".col-md-12" ).addClass( "has-success" ).removeClass( "has-error" );
    }
  });
    
  //load the category data
  $.ajax({
    url: API_BASE_URL + '/category/',
    type: 'get',
    dataType: 'json',
    success:function(response){
      $("#category").empty();
      $("#category").append("<option value=''>Select Category</option>");
      $.each( response, function( i, val ) {
        $("#category").append("<option value='"+val.id+"'>"+val.name+"</option>");
      });
    }
  });

  $.ajax({
    url: API_BASE_URL + '/sub_category/',
    type: 'get',
    dataType: 'json',
    success:function(response){
      $.each( response, function( i, val ) {
        if(typeof (subCategory[val.category_id]) === "undefined") {
          subCategory[val.category_id] = [];
        }
        subCategory[val.category_id].push(val);
      });
    }
  });

  $.ajax({
    url: API_BASE_URL + '/member/',
    type: 'get',
    dataType: 'json',
    success:function(response){
      $("#member").empty();
      $("#member").append("<option value=''>Select Member</option>");
      $.each( response.results, function( i, val ) {
        $("#member").append("<option value='"+val.id+"'>"+val.first_name+" " + val.last_name+"</option>");
      });
    }
  });
  
  $("#category").on("change", function() {
    $("#subCategory").empty();
    if($(this).val()) {
      var resp = subCategory[$(this).val()];
      $("#subCategory").append("<option value=''>Select Sub Category</option>");
      if(typeof(resp) === "undefined") {
        console.log("subcategory not found: " + $(this).find("option:selected").text() );
      } else {
        $.each( resp, function( i, val ) {
          $("#subCategory").append("<option value='"+val.id+"'>"+val.name+"</option>");
        });
      }
    }
  });
  
  
  /*LATER USE*/
  /* ============================================================ */
  /*
  $("#category").on("change", function() {
    $("#subCategory").empty();
    if($(this).val()) {
      console.log("Changes request :"  + $(this).val());
      $.ajax({
        url: API_BASE_URL + '/subcategory/',
        type: 'get',
        dataType: 'json',
        success:function(response){
          $("#subCategory").empty();
          $("#subCategory").append("<option value=''>Select Sub Category</option>");
          $.each( response, function( i, val ) {
            $("#subCategory").append("<option value='"+val.id+"'>"+val.name+"</option>");
          });
        }
      });
    }
  });
  */
  /* ============================================================ */
  //subCategory
  
  $("#saveCourses").on("click", function() {
    var isValidForm = frmvalidatorfrm.form();
    if(isValidForm){
      if($("#tags").val().length === 0) {
        alert("Tags field cannot empty please choice tags!");
        return false;
      }
      var tags = $("#tags").val().join(",");
      
      var formData = new FormData();
      formData.append("course_id_prefix", $("#coursesID").val());
      formData.append("name", $("#coursesName").val());
      formData.append("description", $("#description").val());
      formData.append("platform_id", $("#platform_id").val());
      formData.append("category_id", $("#category").val());
      formData.append("sub_category_id", $("#subCategory").val());
      formData.append("member_id", $("#member").val());
      formData.append("start_date",  $("#start_date").val());
      formData.append("end_date",  $("#end_date").val());
      formData.append("status", 1);
      formData.append("MCStatus", 1);
      formData.append("tags",  tags);
      formData.append("category_name", $("#category").find("option:selected").text());
      formData.append("sub_category_name", $("#subCategory").find("option:selected").text());
      $.each($('input[name^="courseFile"]')[0].files, function(i, file) {
        formData.append("attachments["+i+"]", file, file.name);
      });
      $.ajax({
        url: "https://elearningcontent.zaigoinfotech.com/course/",
        method: "POST",
        type: 'POST', // For jQuery < 1.9
        cache: false,
        contentType: false,
        processData: false,
        data: formData,
        success: function(response){
          $('#addCourses').modal('hide');
          toastr.success("New course information was successfully saved.");
          console.log(response);
        },
        error: function(error) {
          toastr.error("Response Error: " + error.message);
          console.log(error);
        }
      });
    }
  });
});

</script>
