<div class="container-fluid" style="display:none;">
    <div class="row">
      <div class="col-12">
        <div class="c-align d-flex align-center justify-cotent-center">
          <div>
            <div class="round"><img src="../assets/images/course-1.svg" alt="chapters" /></div>
            <h4>Create your first chapters</h4>
            <span class="orange-btn nbtn">
              <button class="add-case"><i class="fas fa-plus"></i> Create Chapters</button>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!--popup start-->
  <div id="createchapter" class="overlay" style="display:none;">
    <div class="popup pt-3">
      <h4 class="mb-3" id="create_chapter_text">Create Chapter</h4>
      <span class="close">×</span>
      <form method="post" id="frmNewChapter" name="frmNewChapter" enctype="multipart/form-data">
        <input type="hidden" name="chapter_id" id="chapter_id" value="">
        <div class="row">
          <div class="col-md-12 mb-3">
              <div class="form-floating">
                <input type="text" id="chapter_name" name="chapter_name" class="form-control cm-capitalize" placeholder=" ">
                <label for="chapter_name">Name of the Chapter</label>
              </div>
          </div>

          <div class="col-md-12 mb-3">
            <div class="form-floating">
              <input type="text" id="short_code" name="short_code" class="form-control cm-replaceSpace" placeholder=" ">
              <label for="short_code">Short Code</label>
            </div>
          </div>

          <div class="col-md-12 mb-3">
            <div class="form-floating">
              <input type="text" id="description" name="description" class="form-control counter"
                placeholder=" " maxlength="1024" minlength="4"/>
              <span class="charcounter">0 Char</span>
              <label for="description">One line description</label>
            </div>
          </div>
        </div>
      </form>

        <div class="row">
          <div class="col-12 pt-3 pb-3 wauto">  <span class="orange-btn nbtn">
            <button class="add-case_save" id="create_chapter_save_text">Create</button>
            </span> </div>
        </div>
    </div>
  </div>

  <!--popup end-->

  <!--Chapter list start-->
  <div class="container-fluid" style="display:block">
    <div class="row">
      <div class="col-12 title-head mb-3">
        <h2>Chapters 
        <dfn data-info="Lorem ipsum dolor sit amet, perspiciatis consectetur dolor."><i class="fas fa-info-circle"></i></dfn></h2>
        <span class="orange-btn nbtn">
          <button class="add-case"><i class="fas fa-plus"></i> Create Chapters</button>
        </span>
      </div>
    </div>
    <div class="row">
        <div class="col-12">
        <div class="white-bg title-head p-3">
            <div class="container-fluid p-0">
                <div class="row">
                <div class="col-lg-4 col-md-4">
                  <div class="searchbar">
                    <h4>List of Chapters 
                    <a class="btn btn-sm btn-danger btnReset d-none" style="position:relative;top:2px;float:right">Reset</a>
                    <dfn data-info="Lorem ipsum dolor sit amet, perspiciatis consectetur dolor."><i class="fas fa-info-circle"></i></dfn></h4>
                  </div>
                </div>
                <div class="col-lg-8 col-md-8 top-btn">
                    <div class="container p-0">
                        <div class="row">
                        <div class="col-lg-8 col-md-8">
                          <div class="topsearch relative">
                          <input class="form-control form-control-dark w-100" type="text" placeholder="Search here" aria-label="Search" id="searchText">
                          <i class="fas fa-search"></i> </div>
                        </div>

                      <div class="col-lg-3 col-md-3">
                        <div class="dropdown-select">
                          <select class="sort-select" id="status">
                            <option value="">Search By</option>
                            <option value="0">Recent</option>
                            <option value="4">Completed</option>
                            <option value="2">Onhold</option>
                            <option value="1">To do</option>
                          </select>
                        </div>
                      </div>


                  </div>
                   </div>

                </div>                
              </div>
            </div>
              </div>
            </div>
      <div class="whitebg col-md-12">
        <div class="container-fluid p-0">
          <div class="table-section">
              <table class="table table-bordered responsive">
                <thead>
                  <tr>
                    <th><div class="form-check">
                      <input class="form-check-input parentcheck_chapter_list" name="chk" type="checkbox" value="" id="myCheck" onclick="selects();">
                      <label class="form-check-label" for="myCheck" role="button">
                      </label>
                    </div></th>               
                    <th>NAME</th>
                    <th>CASE NAME</th>
                    <th>COURSE NAME</th>
                    <th>GROUP NAME</th>
                    <th>ACTIONS</th>
                  </tr>
                </thead>
                <tbody id="listData" class="chapter_list_table">
                  <tr>
                    <td colspan="5">
                      <div class="alert text-center">Loading...</div>
                    </td>
                  </tr>
                </tbody>
              </table>
              <div id="pagination-container"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!--Chapter list end-->
  
<div id="mAlert" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mAlertCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-confirm">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title"><span id="mAlertName"></span></h6>
        <a class="close" data-bs-dismiss="modal">×</a>
      </div>
      <div class="modal-body text-center">
        <div class="col-md-12 text-center mb-2"> <img src="../assets/images/delete.png" alt="Delete"> </div>
        <input type="hidden" id="mAlertURL" value="" />
        <p>Are you sure you want to delete it?</p>
      </div>
      <div class="modal-footer justify-content-center">
        <span class="dborder-btn nbtn">
          <button type="button" id="mAlertCancel" class="btn btn-default" data-bs-dismiss="modal">Cancel</button>
        </span>
        <span class="danger-btn nbtn">
          <button type="button" id="mAlertDelete" class="btn btn-danger">Yes Delete</button>
        </span>
      </div>
    </div>
  </div>
</div>

<script>
var frmvalidatorfrm;

  function doSearch(){
    var queryPara = '?self=';
    if($("#searchText").val()) {
      queryPara += "&search=" + $("#searchText").val();
    }
    //status
    if($("#status").val()) {
      queryPara += "&status=" + $("#status").val();
    }

    $('#pagination-container').pagination({
      dataSource: API_CONTENT_URL + '/chapters/' + queryPara,
      locator: 'data',
      totalNumberLocator: function(response) {
        return response.total;
      },
      alias: {
        pageNumber: 'page',
        pageSize: 'per_page'
      },  
      pageSize: 6,
      ajax: {
        beforeSend: function(request) {
          request.setRequestHeader("Authorization", "Bearer " + getUserInfo().access_token);
        },
        complete: function(jqXHR, textStatus) {
          if (jqXHR.status === 200 || jqXHR.readyState === 0 || jqXHR.status === 0) {
            return false; // do nothing
          } else if (jqXHR && (jqXHR.status === 403)) {
            window.location.href = SITE_URL_PROTOCOL;
          } else if (jqXHR.status === 401) {
            alert($.parseJSON(jqXHR.responseText).detail);
            window.location.href = SITE_URL_PROTOCOL;
          } else {
            alert($.parseJSON(jqXHR.responseText).detail);
          }
        },    
      },
      callback: function(data, pagination) {
        var html = template(data);
        $('#listData').html(html);
        loadAlertModal();
      }
    });

  }
  
  function template(data) {
    var html = '';
    var sno = 0;
    if(data.length > 0) {
      $.each(data, function(index, item) {
        sno = sno + 1;
        html += '<tr>';
        html += `
        <td>
          <div class="form-check">
            <input class="form-check-input" name="chk" type="checkbox" value="`+ item.id +`" id="chk_`+ item.id +`">
            <label class="form-check-label" for="chk_`+ item.id +`" role="button"> </label>
          </div>
        </td>
        `;
        //html += '<td><span class="badge bg-success gridTaskID">#'+ item.short_code +'</span></td>';
        html += '<td data-flinkto="chapterslist" data-chapter_id="'+ item.id +'" data-chapter_name="'+ item.name +'">'+ item.name +'</td>';
        html += '<td data-flinkto="chapterslist" data-chapter_id="'+ item.id +'" data-chapter_name="'+ item.name +'">'+ item.cases +'</td>';
        html += '<td data-flinkto="chapterslist" data-chapter_id="'+ item.id +'" data-chapter_name="'+ item.name +'">'+ item.courses +'</td>';
        html += '<td data-flinkto="chapterslist" data-chapter_id="'+ item.id +'" data-chapter_name="'+ item.name +'">'+ item.groups +'</td>';
        //html += '<td data-flinkto="chapterslist" data-chapter_id="'+ item.id +'" data-chapter_name="'+ item.name +'">'+ item.description +'</td>';
        html += `
          <td class="text-right">
          <div class="dropdown ahide">
            <button class="btn dropdown-toggle dbtn btn-light" type="button" id="dropdownMenuButton3" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fas fa-ellipsis-v"></i></button>
            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton3">`;
            
        if(item.status == '0' || item.status == '1' || item.status == '2' || item.status == '4') {
          html += `<li><a class="dropdown-item green" data-chapter_id='${item.id}' data-chapter_name='${item.name}' data-short_code='${item.short_code}' data-description='${item.description}' onClick='editChapter(this);'>&nbsp;Edit</a></li>`;
        } else {
          html += `<li><a class="dropdown-item green disabled">&nbsp;Edit</a></li>`;
        }
    
        html += `<li>`;
    
        if(item.status == '2' || item.status == '3') {
          html += `<a class="dropdown-item red disabled">&nbsp;Delete<a>`;
        } else {
          html += `<a href="#mAlert" id="delete_` + item.id + `"  data-bs-toggle="modal" data-bs-target="#mAlert" data-name="`+item.name+`" data-url="`+item.id+`/"
                     class="dropdown-item red">&nbsp;Delete</a>`;
        }
        html += `</li>
            </ul>
          </div>
          </td>
        `;
        html += '</tr>';
      });
    } else {
      html += '<tr>';
      html += `
      <td>
        <div class="form-check">
          <input class="form-check-input" name="chk" type="checkbox" value="0" id="chk_0" disabled>
          <label class="form-check-label" for="chk_0"> </label>
        </div>
      </td>
      `;
      html += '<td colspan="6" class="text-center">';
      html += '<span class="text-danger">'+ window.language.no_record_found +'</span>';
      html += '</td>';
      html += '</tr>';
    }
    html += '';
    return html;
  }

  function cardlist(e){
    var elems = document.querySelector(".cardactive");
    if(elems !==null){
      elems.classList.remove("cardactive");
    }
    e.classList.add('cardactive');
  }
  
  $( document ).ready(function() {
    $("input[name='chk']").on("click", function (e) {
      var isFalse_mod = false;
      $("input[name='chk']:not(.parentcheck_chapter_list)").each( function () {
        if($(this).is(":checked") == true) {
          isFalse_mod = true;
        }
      });
      if(!isFalse_mod) {
        //parentcheck
        $("#myCheck").prop("checked", false);
      }
    });
    $('.cm-capitalize').each(function () { $(this).capitalize(); });
    $('.cm-uppercase').each(function () { $(this).upperCase(); });
    $('.cm-replaceSpace').each(function () { $(this).replaceSpace(); });
  
    $('.counter').on("keyup", function () {
      var cuChar = $(this).val().length;
      $(this).next("span.charcounter").html(cuChar + " Char");
    });
  
    $("#chapter_name").on("blur", function () {
      var str = $(this).val();
      if(!$("#short_code").val()) {
        var acpref = str.substring(0, 4);
        $("#short_code").val(acpref.str_replace(' ', '-').toUpperCase());
      }
    });

      $.validator.addMethod("pattern", function (value, element, param) {
        if (this.optional(element)) { return true; }
        if (typeof param === "string") {
          param = new RegExp("^(?:" + param + ")$");
        }
        return param.test(value);
      }, "Check your inputs");
      window.frmvalidatorfrm = $("#frmNewChapter").validate({
        rules: {
          chapter_name: { required: true, minlength: 1, maxlength: 256 },
          description: { required: true, minlength: 1, maxlength: 256 },
          short_code: { required: true, maxlength: 256 },
        },
        messages: {
          chapter_name: {
            required: "Please enter a Chapter Name",
            minlength: "Your case name must consist of at least 1 characters",
            maxlength: "Your case name must consist of max of 256 characters",
          },
          description: {
            required: "Please enter a description",
            minlength: "Description must consist of at least 1 characters",
            maxlength: "Description must consist of max of 20 characters",
          },
          short_code: { 
            required: "Please enter a code",
            maxlength: "Your case name must consist of max of 256 characters",
          },
        },
        errorElement: "em",
        errorPlacement: function (error, element) {
          error.addClass("help-block");
          if (element.prop("type") === "checkbox") {
            error.insertAfter(element.parent("label"));
          } else {
            error.insertAfter(element);
          }
        },
        highlight: function (element, errorClass, validClass) {
          $(element).addClass("is-invalid");
        },
        unhighlight: function (element, errorClass, validClass) {
          $(element).removeClass("is-invalid");
        }
      });
  
    $(".add-case").click(function(){
      window.sharedEditChapterId = "";
      $( '#frmNewChapter' ).each(function(){
          this.reset();
          window.frmvalidatorfrm.resetForm();
          $('#frmNewChapter .form-control').removeClass('is-invalid');
      });
      $("#createchapter").addClass("overlay_target");
      $("#createchapter").attr("style","display:block");
      $("#create_chapter_text").text("Create Chapter");
      $("#create_chapter_save_text").text("Create");

      $('.counter').on("keyup", function () {
        var cuChar = $(this).val().length;
        $(this).next("span.charcounter").html(cuChar + " Char");
      });
      
    });
    $(".close").click(function(){
      $("#createchapter").removeClass("overlay_target");
      $("#createchapter").attr("style","display:none");
      window.sharedEditChapterId = "";
      $("span.charcounter").html("0 Char");
    });
    
    $(".btnReset").on("click", function(){
      $("#status, #searchText").val(null);
      doSearch();
      setTimeout(function() {
        $(".btnReset").addClass("d-none");
      }, 500);
    });
    $(".fa-search").on("click", function(){ 
      $(".btnReset").removeClass("d-none");
      doSearch(); 
    });
    $("#status").on("change", function(){ doSearch(); $(".btnReset").removeClass("d-none");});

    //load the courses list
    $.ajax({
      url: API_CONTENT_URL + '/chapters_list/',
      type: 'get',
      dataType: 'json',
      headers: {
        "Authorization": "Bearer " + getUserInfo().access_token,
        "Content-Type": "application/json"
      },
      success:function(response){
        $("#chapter_list").empty();
        $("#chapter_list").append("<option value=''>Select Chapter</option>");
        $.each( response, function( i, val ) {
          $("#chapter_list").append("<option value='"+val.id+"'>"+val.name+"</option>");
        });
      },
      error: function(error){
        console.log(error);
      }
    });
  
    if($( "#pagination-container" ).length > 0) {
      doSearch();
    }

    $("#create_chapter_save_text").on("click", function () {
      var isValidForm = window.frmvalidatorfrm.form();
      if (isValidForm) {
        var formData = new FormData();
        formData.append("name", $("#chapter_name").val());
        formData.append("short_code", $("#short_code").val());
        formData.append("description", $("#description").val());
        var chapter_id = window.sharedEditChapterId;
        var URL = API_CONTENT_URL + "/chapters/";
        var method = "POST";
        var type = "POST";
        if(chapter_id != ""){
          var URL = API_CONTENT_URL + "/chapters/"+chapter_id+"/";
          var method = "PUT";
          var type = "PUT";
        }
        $.ajax({
          url: URL,
          method: method,
          type: type, // For jQuery < 1.9
          cache: false,
          contentType: false,
          processData: false,
          data: formData,
          headers: {
            "Authorization": "Bearer " + getUserInfo().access_token
          },
          success: function (response) {
            toastr.success("New Chapter was successfully saved.");
            $(".close").trigger("click");
            $("#createchapter").attr("style","display:none");
            $("#createchapter").removeClass("overlay_target");
            window.sharedEditChapterId = "";
            $("span.charcounter").html("0 Char");
            doSearch();
          },
          error: function (error) {
            toastr.error("Response Error: " + error.message);
            console.log(error);
          }
        });
      }
    });

  });
  
  function editChapter(e){
    $('#frmNewChapter').each(function(){
      this.reset();
      window.frmvalidatorfrm.resetForm();
      $('#frmNewChapter .form-control').removeClass('is-invalid');
    });
    window.sharedEditChapterId = e.dataset.chapter_id;
    if(window.sharedEditChapterId){
      $("#createchapter").attr("style","display:block");
      $("#createchapter").addClass("overlay_target");
      $("#create_chapter_text").html("Edit : <small>" + e.dataset.chapter_name.substring(0, 50)) + "</small>";
      $("#create_chapter_save_text").text("Update");
      $("#chapter_id").val(e.dataset.chapter_id);
      $("#chapter_name").val(e.dataset.chapter_name);
      $("#short_code").val(e.dataset.short_code);
      $("#description").val(e.dataset.description);
      if(e.dataset.description) {
        var cuChar = $("#description").val().length;
        $("#description").next("span.charcounter").html(cuChar + " Char");
      }
      //description
    }
  }

  function loadAlertModal(){
    $('#mAlert').on('shown.bs.modal', function (event) {
      var button = $(event.relatedTarget);
      var recipientID = button.data('url');
      var name = button.data('name');
      var modal = $(this);
      modal.find('.modal-content input').val(recipientID);
      modal.find('.modal-content #mAlertName').html(name);
      $("#mAlertCancel").focus();
      //mAlertDelete

      //mAlertCancel
      $(document).on('click', '#mAlertCancel', function() {
        $(document).off('click', '#mAlertCancel');
        $(document).off('click', '#mAlertDelete');
      });

      $(document).off('click', '#mAlertDelete');
      $(document).on('click', '#mAlertDelete', function() {
        var url = $("#mAlertURL").val();
        if(url) {
          $.ajax({
            url: API_CONTENT_URL + '/chapters/' + url + '/',
            type: 'DELETE',
            headers: {
              "Authorization": "Bearer " + getUserInfo().access_token
            },
            success:function(response){
              toastr.success("Chapter deleted successfully.");     
              $("#mAlertCancel").click();     
              doSearch();
            },
            error: function(error) {
              console.log(error);
              toastr.error("Response Error: " + error.detail);
            }
          });
        } else {
          alert("Not selected!");
        }
      });

    });
    //hidden.bs.modal 
    $('#mAlert').on('hidden.bs.modal', function (event) {
      $(document).off('click', '#mAlertCancel');
      $(document).off('click', '#mAlertDelete');
      var modal = $(this);
      modal.find('.modal-content input').val(null);
      modal.find('.modal-content #mAlertName').html("Loading...");
    });
  }

</script>
