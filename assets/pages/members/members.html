<div class="container-fluid">
  <div class="row">
    <div class="col-12 title-head mb-3">
      <div class="container-fluid p-0">
        <div class="row">
          <div class="col-md-6">
            <h2> Members <dfn
                data-info="Lorem ipsum dolor sit amet, perspiciatis consectetur dolor."
                ><i class="fas fa-info-circle"></i
              ></dfn> </h2>
          </div>
          <div class="col-md-6 p-0 side-btn">
            <ul>
              <!--
              <li id="member-bulk-upload"> <span class="border-btn"><a href="#addusers"><button><i class="fas fa-plus"></i> Bulk Upload</button></a></span></li>
              -->
              <li id="member-add"> <span class="orange-btn"><button id="trigger-member-create-form"> <i class="fas fa-plus"></i> Add Member </button></span> </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="memberListContainer">
    <div class="container-fluid p-0">
    <div class="row">
      <div class="col-12">
        <div class="white-bg title-head p-3">
          <div class="container-fluid p-0">
            <div class="row">
              <div class="col-lg-4 col-md-4">
                <div class="searchbar">
                  <h4> List of Members <dfn data-info="Lorem ipsum dolor sit amet, perspiciatis consectetur dolor."><i class="fas fa-info-circle"></i></dfn> </h4>
                </div>
              </div>
              <div class="col-lg-8 col-md-8 top-btn">
                <div class="row">
                  <div class="col-lg-2 col-md-2 p-0">
                    <a class="btn btn-sm btn-danger btnReset d-none" style="position:relative;top:2px;">Reset</a>
                  </div>
                  <div class="col-lg-4 col-md-4">
                    <div class="topsearch relative">
                      <input
                        class="form-control form-control-dark w-100"
                        type="text"
                        placeholder="Search Here"
                        aria-label="Search"
                        id="searchText"
                      />
                      <i class="fas fa-search btnSearch"></i> </div>
                  </div>
                  <div class="col-lg-3 col-md-3">
                    <div class="dropdown-select">
                      <select class="sort-select member-role-list" id="role_list">
                        <option value="" selected disabled>Select Role</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-lg-3 col-md-3">
                    <div class="dropdown-select">
                      <select class="form-control sort-select" id="status">
                        <option value="">Status</option>
                        <option value="1">Active</option>
                        <option value="2">InActive</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="whitebg col-md-12">
        <div class="container-fluid p-0">
          <div class="white-bg p-3 mt-3">
            <div class="p-0">
              <div class="table-section">
                <table class="table table-bordered responsive">
                  <thead>
                    <tr>
                      <th> <div class="form-check">
                          <input
                            class="form-check-input parentcheck"
                            name="chk"
                            type="checkbox"
                            value=""
                            id="myCheck"
                            onclick="selects()"
                          />
                          <label class="form-check-label" for="myCheck"> </label>
                        </div>
                      </th>
                      <th>S.No</th>
                      <th>NAME</th>
                      <th>EMAIL</th>
                      <th>PHONE NO</th>
                      <th>ROLE</th>
                      <th>ACTIONS</th>
                    </tr>
                  </thead>
                  <tbody id="memberListDataContainer">
                    <!-- HTML snippet will be dynamically appended-->
                    <tr>
                      <td colspan="7">
                        <div class="alert text-center">Loading...</div>
                      </td>
                    </tr>
                  </tbody>
                </table>
                <div id="pagination-container"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
</div>
<!-- Member Create Form Start -->
<div id="member-create-form-container" class="overlay">
  <div class="popup">
    <h4>Add New Member</h4>
    <span class="cancel-member-create-form close" href="#">&times;</span>
    <form class="pop-form" id="member-create-form">
      <div class="row mb-3">
        <div class="col-md-12">
          <div class="topsearch relative">
            <input
              class="form-control form-control-dark w-100"
              id="member-email"
              name="email_id"
              type="text"
              autocomplete="off"
              placeholder="Search by Email"
              aria-label="Search"
            />
            <i class="fas fa-search"></i> </div>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-6">
          <input
            id="member-fName"
            name="first_name"
            type="name"
            class="form-control"
            placeholder="First Name"
            disabled
          />
        </div>
        <div class="col-md-6">
          <input
            id="member-lName"
            name="last_name"
            type="name"
            class="form-control"
            placeholder="Last Name"
            disabled
          />
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-12">
          <input
            id="member-phoneNo"
            name="phone_number"
            type="number"
            class="form-control"
            placeholder="Phone No"
            min="0"
            disabled
          />
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-12">
          <div class="dropdown-select">
            <select
              class="form-control sort-select"
              id="member-role"
              name="roles_name"
              disabled
            >
              <option value="" selected disabled>Select Role</option>
              <!-- HTML snippet will be dynamically appended-->
            </select>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-12 pt-3 pb-3 wauto"> <span class="border-btn nbtn">
          <button class="cancel-member-create-form" type="button"> Cancel </button>
          </span> <span class="orange-btn nbtn">
          <button id="save-member-create-form" type="submit">Save</button>
          </span> </div>
      </div>
    </form>
  </div>
</div>
<!-- Member Create Form End -->
<!--
<div id="addusers" class="overlay">
  <div class="popup defaultopen">
    <h4>Bulk Upload Members</h4>
    <a class="close" href="#">&times;</a>
    <div class="col-lg-12 col-md-12 mt-3 mb-3">
      <div class="dropdown-select">
        <select id="" class="form-control sort-select member-role-list">
        </select>
      </div>
    </div>
    <div class="col-lg-12 col-md-12 mb-3 buttonupload">
        <div id="drop-zone" class="drop-zone">
          <div id="clickHere"><i class="fas fa-plus"></i> Attach File 
            <input type="file" name="file" id="file" multiple />
          </div>          
        </div>
        <div id='filename'></div>
    </div>
    <div class="col-lg-12 col-md-12 mt-2 mb-2 text-right"> <span class="orange-btn nbtn"
        ><a href="#">
      <button>Save</button>
      </a></span
      > </div>
  </div>
</div>
-->
<div id="delete" class="overlay">
  <div class="popup"> <a class="close" href="#">×</a>
    <form method="get" class="pop-form">
      <div class="row">
        <div class="col-md-12 text-center mb-2"> <img src="../assets/images/delete.png" /> </div>
        <div class="col-md-12 text-center mb-2">
          <p>Are you sure you want to delete it</p>
        </div>
      </div>
      <div class="row">
        <div class="col-12 pt-3 pb-3 wauto text-center"> <span class="dborder-btn nbtn"
            ><a href="#">
          <button>Cancel</button>
          </a></span
          > <span class="danger-btn nbtn"
            ><a href="#">
          <button>Delete</button>
          </a></span
          > </div>
      </div>
    </form>
  </div>
</div>

<script>
$(function () {
    var dropZoneId = "drop-zone";
    var buttonId = "clickHere";
    var mouseOverClass = "mouse-over";
    var dropZone = $("#" + dropZoneId);
    
    if(dropZone.length > 0) {
      var ooleft = dropZone.offset().left;
      var ooright = dropZone.outerWidth() + ooleft;
      var ootop = dropZone.offset().top;
      var oobottom = dropZone.outerHeight() + ootop;
      var inputFile = dropZone.find("input");
      document.getElementById(dropZoneId).addEventListener("dragover", function (e) {
          e.preventDefault();
          e.stopPropagation();
          dropZone.addClass(mouseOverClass);
          var x = e.pageX;
          var y = e.pageY;
  
          if (!(x < ooleft || x > ooright || y < ootop || y > oobottom)) {
              inputFile.offset({
                  top: y - 15,
                  left: x - 100
              });
          } else {
              inputFile.offset({
                  top: -400,
                  left: -400
              });
          }
  
      }, true);
      if (buttonId != "") {
          var clickZone = $("#" + buttonId);
  
          var oleft = clickZone.offset().left;
          var oright = clickZone.outerWidth() + oleft;
          var otop = clickZone.offset().top;
          var obottom = clickZone.outerHeight() + otop;
  
          $("#" + buttonId).mousemove(function (e) {
              var x = e.pageX;
              var y = e.pageY;
              if (!(x < oleft || x > oright || y < otop || y > obottom)) {
                  inputFile.offset({
                      top: y - 15,
                      left: x - 160
                  });
              } else {
                  inputFile.offset({
                      top: -400,
                      left: -400
                  });
              }
          });
      }
      document.getElementById(dropZoneId).addEventListener("drop", function (e) {
          $("#" + dropZoneId).removeClass(mouseOverClass);
      }, true);
      inputFile.on('change', function (e) {
          $('#filename').html("");
          var fileNum = this.files.length,
              initial = 0,
              counter = 0;
      var filenamenew = '';
          for (initial; initial < fileNum; initial++) {
              counter = counter + 1;
        var filename = this.files[initial].name;
        if(filename){
          console.log(filename);
          splitfilename = filename.split(".");
          console.log(filename);
          if(splitfilename[0]){
          filenamenew = splitfilename[0].substring(0, 10);
          filenamenew = filenamenew.replace(/[\/-]+/g, '');
          //filenamenew.replace('-', '');
          //filenamenew.replace('/','');
          filenamenew = filenamenew +'.'+splitfilename[1];
          }
        }
          
        
              $('#filename').append('<div class="fileuploads"><span class="fa-stack fa-lg"><i class="fa fa-file fa-stack-1x "></i><strong class="" style="color:#FFF; font-size:12px; margin-top:2px;">'+ counter + '</strong></span> ' + filenamenew + '&nbsp;&nbsp;<span class="fa fa-times-circle fa-lg closeBtn" title="remove"></span><br></div>');
          }
      });
    }
})
$(document).on('click','.fa-lg.closeBtn',function(){
		console.log('earwr');
		$(this).parent('.fileuploads').remove();	
});
</script> 

<script type="application/javascript">
var roleList = '';
function doSearch(){
  gridMembers("pagination-container", "memberListDataContainer");
}
$( document ).ready(function() {
  //roleID
  $.ajax({
    url: 'https://elearningadmin.zaigoinfotech.com/roles/',
    type: 'get',
    dataType: 'json',
    headers: {"Content-type": "application/json; charset=UTF-8", "Authorization": "Bearer " + getUserInfo().access_token},
    success:function(response){
      roleList = response;
      $("#role_list").empty();
      $("#role_list").append("<option value=''>Select Role</option>");
      $.each( response, function( i, val ) {
        $("#role_list").append("<option value='"+val.id+"'>"+val.name+"</option>");
      });
    }
  });
  
  $(".btnReset").on("click", function(){
    $("#status, #role_list, #searchText").val(null);
    doSearch();
    setTimeout(function() {
      $(".btnReset").addClass("d-none");
    }, 500);
  });

  $(".btnSearch").on("click", function(){ 
    $(".btnReset").removeClass("d-none");
    doSearch(); 
  });
  $("#status, #role_list").on("change", function(){ doSearch(); $(".btnReset").removeClass("d-none");});
  $('.btnRadio').click(function(){ doSearch(); });
  
  if(window.selectedRoleID) {
    setTimeout(function(){
      $("#role_list").val(window.selectedRoleID).change();
      window.selectedRoleID = null;
    }, 1500);
  } else {
    doSearch();
  }
  
});

function gridMembers(tagID, htmlID, assignTOBY){
  var queryPara = '?p=0';
  //check for search field
  if($("#searchText").val()) {
    queryPara += "&search=" + $("#searchText").val();
  }
  //role_list
  if($("#role_list").val()) {
    queryPara += "&roles_name=" + $("#role_list").val();
  }
  //status
  if($("#status").val()) {
    queryPara += "&status=" + $("#status").val();
  }

  $('#' + tagID).pagination({
    dataSource: 'https://elearningadmin.zaigoinfotech.com/member/' + queryPara,
    locator: 'data',
    totalNumberLocator: function(response) {
      return response.total;
    },
    alias: {
      pageNumber: 'page',
      pageSize: 'per_page'
    },  
    pageSize: 6,
    ajax: {
      beforeSend: function(request) {
        request.setRequestHeader("Authorization", "Bearer " + getUserInfo().access_token);
      },
      complete: function(jqXHR, textStatus) {
        if (jqXHR.status === 200 || jqXHR.readyState === 0 || jqXHR.status === 0) {
          return false; // do nothing
        } else if (jqXHR) {
          var res = jqXHR.response;
          if(jqXHR.status == 403) {
            if($.parseJSON(jqXHR.responseText).detail) {
              toastr.error($.parseJSON(jqXHR.responseText).detail);
              get403Page();
            } else {
              console.log(jqXHR.responseText);
            }
          } else {
            console.error("There was an error!", error.response);
          }
        } else {
          alert('error');
        }
      },    
    },
    callback: function(data, pagination) {
      var html = template(data);
      $('#' + htmlID).html(html);
      loadAlertModal();
    }
  });
}

function template(data, tagTOBY) {
  var html = '';
  $.each(data, function(index, item) {
    html += '<tr>';
    
    html += `
    <td>
      <div class="form-check">
        <input class="form-check-input" name="chk" type="checkbox" value="`+ item.id +`" id="chk_`+ item.id +`">
        <label class="form-check-label" for="chk_`+ item.id +`"> </label>
      </div>
    </td>
    `;
    html += '<td><span class="">'+ (index + 1) +'</span></td>';
    html += '<td class="wrap">'+ item.first_name + ' ' + item.last_name +'</td>';
    html += '<td>'+ item.email_id +'</td>';
    html += '<td>'+ item.phone_number +'</td>';
    html += '<td><span class="green-shade"><a href="#">'+ item.role_name +'</a></span></td>';
    html += `
      <td class="text-center">
      <div class="dropdown ahide">
        <button class="btn dropdown-toggle dbtn btn-light" type="button" id="dropdownMenuButton3" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="fas fa-ellipsis-v"></i></button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton3">`;

    if(item.status == '0' || item.status == '1' || item.status == '2' || item.status == '4') {
      //Add/Edit Member
      if(processRights("Add/Edit Member") === false) {
        html += `<li><a class="dropdown-item green disabled">&nbsp;Edit</a></li>`;
      } else {
        html += `<li><a class="dropdown-item green" href="#taskdetails">&nbsp;Edit</a></li>`;
      }
    } else {
      html += `<li><a class="dropdown-item green disabled">&nbsp;Edit</a></li>`;
    }

    html += `<li>`;
    
    if(processRights("Delete Member") === false) {
      html += `<a class="dropdown-item red disabled">&nbsp;Disable<a>`;
    } else {
      if(item.status == '0' || item.status == '1') {
        html += `<a id="disabled_` + item.id + `" data-name="`+item.first_name+`" data-url="`+item.id+`" class="dropdown-item red mDisabled">&nbsp;Disable</a>`;
      } else if(item.status == '2') {
        html += `<a id="enabled_` + item.id + `" data-name="`+item.first_name+`" data-url="`+item.id+`" class="dropdown-item red mEnabled">&nbsp;Enabled</a>`;
      } else {
        html += `<a class="dropdown-item red disabled">&nbsp;Disable<a>`;
      }
    }

    html += `</li><li>`;
    
    if(item.status == '2' || item.status == '3') {
      html += `<a class="dropdown-item red disabled">&nbsp;Delete<a>`;
    } else {
      if(processRights("Delete Member") === false) {
        html += `<a class="dropdown-item red disabled">&nbsp;Delete<a>`;
      } else {
        html += `<a href="#mAlert" id="delete_` + item.id + `"  data-bs-toggle="modal" data-bs-target="#mAlert" data-name="`+item.first_name+ ` ` +item.last_name+`" data-url="`+item.id+`/" class="dropdown-item red">&nbsp;Delete</a>`;
      }
    }
    html += `</li>
        </ul>
      </div>
      </td>
    `;
    html += '</tr>';
  });
  html += '';
  return html;
}

function loadAlertModal(){
  $('#mAlert').on('shown.bs.modal', function (event) {
    var button = $(event.relatedTarget);
    var recipientID = button.data('url');
    var name = button.data('name');
    var modal = $(this);
    modal.find('.modal-content input').val(recipientID);
    modal.find('.modal-content #mAlertName').html(name);
    $("#mAlertCancel").focus();
    //mAlertDelete
    $(document).on('click', '#mAlertDelete', function() {
      var url = $("#mAlertURL").val();
      $.ajax({
        url: 'https://elearningadmin.zaigoinfotech.com/member/' + url,
        type: 'PATCH',
        data: JSON.stringify({
          "status": 3
        }),
        headers: {
          "Authorization": "Bearer " + getUserInfo().access_token,
          "Content-Type": "application/json"
        },
        success:function(response){
          $("#mAlertCancel").click();
          doSearch();
        },
        error: function(error) {
          toastr.error("Response Error: " + error.message);
          console.log(error);
        }
      });
    });
    //mAlertCancel
    $(document).on('click', '#mAlertCancel', function() {
      $(document).off('click', '#mAlertCancel');
      $(document).off('click', '#mAlertDelete');
    });
    
  });
  
  //hidden.bs.modal	
  $('#mAlert').on('hidden.bs.modal', function (event) {
    $(document).off('click', '#mAlertCancel');
    $(document).off('click', '#mAlertDelete');
    var modal = $(this);
    modal.find('.modal-content input').val(null);
    modal.find('.modal-content #mAlertName').html("Loading...");
  });
  
  $(".mDisabled").on("click", function(){
    var url = $(this).data("url");
    $.ajax({
      url: 'https://elearningadmin.zaigoinfotech.com/member/' + url + '/',
      type: 'PATCH',
      data: JSON.stringify({
        "status": 2
      }),
      headers: {
        "Authorization": "Bearer " + getUserInfo().access_token,
        "Content-Type": "application/json"
      },
      success:function(response){
        doSearch();
      },
      error: function(error) {
        toastr.error("Response Error: " + error.message);
        console.log(error);
      }
    });
  });
  
  //mEnabled
  $(".mEnabled").on("click", function(){
    var url = $(this).data("url");
    $.ajax({
      url: 'https://elearningadmin.zaigoinfotech.com/member/' + url + '/',
      type: 'PATCH',
      data: JSON.stringify({
        "status": 1
      }),
      headers: {
        "Authorization": "Bearer " + getUserInfo().access_token,
        "Content-Type": "application/json"
      },
      success:function(response){
        doSearch();
      },
      error: function(error) {
        toastr.error("Response Error: " + error.message);
        console.log(error);
      }
    });
  });

}

</script>

<div id="mAlert" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mAlertCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-confirm">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title"><span id="mAlertName"></span></h6>
        <a class="close" data-bs-dismiss="modal">×</a>
      </div>
      <div class="modal-body text-center">
        <div class="col-md-12 text-center mb-2"> <img src="../assets/images/delete.png" alt="Delete"> </div>
        <input type="hidden" id="mAlertURL" value="" />
        <p>Are you sure you want to delete it?</p>
      </div>
      <div class="modal-footer justify-content-center">
        <span class="dborder-btn nbtn">
          <button type="button" id="mAlertCancel" class="btn btn-default" data-bs-dismiss="modal">Cancel</button>
        </span>
        <span class="danger-btn nbtn">
          <button type="button" id="mAlertDelete" class="btn btn-danger">Yes Delete</button>
        </span>
      </div>
    </div>
  </div>
</div>